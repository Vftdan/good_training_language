# Хороший Учебный Язык (ХУЯ)

*Если Вам не нравится имя языка, можете опустить букву Х, и называть его просто Учебным Языком. Но знайте — в таком случае язык уже не будет «Хорошим»! ;)*

## Быстрый Старт

Вам потребуется установить компилятор [Rust](https://www.rust-lang.org/).

```console
$ rustc ./исходники/хуяк.rs
```

### Компиляция в Исполняемый Файл

На данный момент поддерживается только платформа Linux x86_64.

```console
$ ./хуяк комп ./примеры/01-привет.хуя
$ ./примеры/01-привет
```

Для других платформ можно попробовать Интерпретацию.

### Интерпретация

Интерпретация просто опускает стадию генерации машинного кода из промежуточного представления (ПП) и тупо интерпретирует ПП. По идее, это должно быть кроссплатформенным, но я не гарантирую, что не добавлю что-нибудь платформо-зависимое в ПП в будущем.

```console
$ ./хуяк интер ./примеры/01-привет.хуя
```

## Модель Абстрактной Машины

Программы данного языка исполняются на некой абстрактной машине, в которую входят

- Память адресуемая побайтово;
- Стек адресуемый по 8 байт (64-битное слово), и располагающийся где-то в Памяти;
- Неявный регистр, хранящий адрес на вершину стека;
- Неявный регистр, хранящий адрес на начало кадра стека;
- Отдельная от Памяти область, где располагаются Инструкции программы;
- Неявный регистр, хранящий индекс текущей исполняемой Инструкции программы.

Инструкции включают в себя операции манипуляции памяти, стека и потока исполнения. Список инструкций на данный момент еще не устоялся, поэтому не будет здесь приведен. Текущий список можно найти в модуле [./исходники/компиляция.rs](./исходники/компилятор.rs).

### Порядок передачи аргументов в процедуру

#### Вызывающая сторона

Все требуемые аргументы должны быть положены на вершину стека:

```
[арг1] <- вершина
[арг2]
[арг3]
...
```

После чего должны быть исполнена инструкция вызова процедуры.

Если процедура возвращает значение, место под результат должно быть зарезервировано под аргументами:

```
[арг1] <- вершина
[арг2]
[арг3]
[результат]
...
```

Процедура обязана использовать механизмы чтения/записи кадров чтобы модифицировать `[результат]`.

После того как процедура вернулась, вызывающая сторона обязана сам вытолкнуть все аргументы оставив только результат для последующих вычислений.

#### Вызываемая сторона

После того как процедуры была вызвана, стек будет выглядеть так:

```
[адрес возврата] <- вершина
[арг1]
[арг2]
[арг3]
[результат]
...
```

Первое, что обязана процедура сделать, это сохранить кадр:

```
[предыдущий адрес кадра]  <- вершина <- кадр
[адрес возврата]
[арг1]
[арг2]
[арг3]
[результат]
...
```

Затем она может выделить какое-то место для локальных переменных:

```
[локал3] <- вершина
[локал2]
[локал1]
[предыдущий адрес кадра] <- кадр
[адрес возврата]
[арг1]
[арг2]
[арг3]
[результат]
...
```

После завершения исполнения процедура обязана вытолкнуть все локальные переменные из стека и восстановить кадр. После чего она может спокойно вернутся в `[адрес возврата]` не вершине стека.

Модификция результата, аргументов и локальных переменных должна происходить через механизмы чтения/записи кадра. Чисто технически возможна модфикация адреса возврата и предыдущего адреса кадра, но на практике это не рекомендуется, и компилятор не должен генерировать код, который это сделает.

## Источники

- Wikipedia - Учебный алгоритмический язык - https://ru.wikipedia.org/wiki/Учебный_алгоритмический_язык - проект по-большей части вдохновлён, но не основан на Учебном Алгоритмическом Языке Андрея Петровича Ершова.
- Tsoding - Porth - https://gitlab.com/tsoding/porth (анг.) - очень много идей реализации были разработаны и опробованны мною еще в Porth.
- https://defuse.ca/online-x86-assembler.htm (анг.) - очень полезный ресурс, чтобы быстро сгенерировать машинный код какой-нибудь комманды интелевского ассемблера x86. Активно использовался при реализации [./исходники/эльф.rs](./исходники/эльф.rs).
- https://flatassembler.net/ (анг.) - простой ассемблер способный генерировать минималистичные статические исполняемые файлы. Вывод данного ассембрера был взят за основнову для генерации ELF файлов при реализации [./исходники/эльф.rs](./исходники/эльф.rs).
- Félix Cloutier - x86 and amd64 instruction reference - https://www.felixcloutier.com/x86/ (анг.) - онлайн справочник по инструкциям процессора Intel x86.
- x0nu11byt3 - ELF Format Cheatsheet - https://gist.github.com/x0nu11byt3/bcb35c3de461e5fb66173071a2379779 (анг.) - шпаргалка по бинарному формату исполняемых файлов ELF. Активно использовалася при реализации [./исходники/эльф.rs](./исходники/эльф.rs)
- ChromiumOS - Linux System Call Table - https://chromium.googlesource.com/chromiumos/docs/+/HEAD/constants/syscalls.md (анг.) - Таблица системных вызовов операционной системы Linux
